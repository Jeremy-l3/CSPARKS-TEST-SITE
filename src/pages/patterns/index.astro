---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PatternCard from '../../components/patterns/PatternCard.astro';
import { getCollection } from 'astro:content';

const patterns = await getCollection('patterns');

// Collect unique tags across all patterns
const allTags = new Set<string>();
patterns.forEach((p) => {
  p.data.tags?.forEach((tag) => allTags.add(tag));
});
const tags = Array.from(allTags).sort();

// Count patterns per tag
const tagCounts = tags.map((tag) => ({
  tag,
  count: patterns.filter((p) => p.data.tags?.includes(tag)).length,
}));
---

<BaseLayout title="Patterns · Collaborative Sparks">
  <!-- Liked Patterns section (always visible; content controlled by script) -->
  <section id="liked-section" class="space-y-4 mb-10">
    <header class="flex items-center justify-between gap-2">
      <h2 class="text-lg font-semibold">Your liked patterns</h2>
      <p class="text-xs text-sparks-ink/60">
        This shelf shows patterns you've starred on this device.
      </p>
    </header>

    <p id="liked-empty" class="text-xs text-sparks-ink/60">Like a pattern to see it appear here.</p>

    <div id="liked-grid" class="grid gap-4 md:grid-cols-3">
      <!-- Populated on the client from the main grid below -->
    </div>
  </section>

  <!-- Tags section -->
  {
    tags.length > 0 && (
      <section class="space-y-4 mb-10">
        <header class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Browse by tag</h2>
          <a href="/patterns/families" class="text-xs text-sparks-teal hover:underline">
            View all tags →
          </a>
        </header>

        <div class="flex flex-wrap gap-2">
          {tagCounts.map(({ tag, count }) => (
            <a
              href={`/patterns/families/${encodeURIComponent(tag)}`}
              class="px-3 py-1.5 rounded-full border border-sparks-amber/30 bg-white/80 hover:bg-sparks-sun/20 transition text-sm"
            >
              {tag}
              <span class="text-xs text-sparks-ink/50 ml-1">({count})</span>
            </a>
          ))}
        </div>
      </section>
    )
  }

  <!-- Main Patterns section -->
  <section class="space-y-6">
    <header class="space-y-2">
      <h1 class="text-2xl font-semibold">Patterns</h1>
      <p class="text-sm text-sparks-ink/80 max-w-2xl">
        Each pattern captures a reusable solution to a recurring challenge in collaboration. Think
        of them as navigational aids in a complex terrain.
      </p>
    </header>

    <div class="grid gap-4 md:grid-cols-3">
      {
        patterns.map((p) => (
          <div data-pattern-slug={p.slug}>
            <PatternCard pattern={p} />
          </div>
        ))
      }
    </div>
  </section>

  <script>
    const likedGrid = document.getElementById('liked-grid');
    const likedEmpty = document.getElementById('liked-empty');

    function updateLikedShelf() {
      if (!likedGrid || !likedEmpty) return;

      // clear old shelf
      likedGrid.innerHTML = '';

      const cards = Array.from(document.querySelectorAll('[data-pattern-slug]'));

      let anyLiked = false;

      cards.forEach((card) => {
        const icon = card.querySelector('.cs-like-icon');
        if (!icon) return;

        const isLiked = icon.textContent === '★';

        // highlight liked in main grid
        card.classList.toggle('ring-2', isLiked);
        card.classList.toggle('ring-sparks-teal/60', isLiked);

        if (isLiked) {
          anyLiked = true;
          const clone = card.cloneNode(true);
          likedGrid.appendChild(clone);
        }
      });

      if (anyLiked) {
        likedEmpty.classList.add('hidden');
      } else {
        likedEmpty.classList.remove('hidden');
      }
    }

    // Run once after load (to pick up persisted likes)
    window.addEventListener('load', () => {
      updateLikedShelf();
    });

    // Re-run whenever likes change (event from LikeButton)
    window.addEventListener('csparks-likes-changed', () => {
      updateLikedShelf();
    });
  </script>
</BaseLayout>
