---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PatternCard from '../../components/patterns/PatternCard.astro';
import { getCollection } from 'astro:content';

const patterns = await getCollection('patterns');

// Hard-coded curated family placeholders
const curatedFamilies = ['Sociocracy 3.0', 'Teal Organizations', 'Space Trains'] as const;

const familyDescriptions: Record<string, string> = {
  'Sociocracy 3.0':
    'Patterns and tools for distributed governance, consent, and continuous learning.',
  'Teal Organizations': 'Ecosystems of self-management, wholeness, and evolutionary purpose.',
  'Space Trains':
    'Speculative sensemaking, coordination architectures, and cosmic-scale collaboration metaphors.',
};
---

<BaseLayout title="Patterns · Collaborative Sparks">
  <!-- Liked Patterns section (always visible; content controlled by script) -->
  <section id="liked-section" class="space-y-4 mb-10">
    <header class="flex items-center justify-between gap-2">
      <h2 class="text-lg font-semibold">Your liked patterns</h2>
      <p class="text-xs text-sparks-ink/60">
        This shelf shows patterns you’ve starred on this device.
      </p>
    </header>

    <p id="liked-empty" class="text-xs text-sparks-ink/60">Like a pattern to see it appear here.</p>

    <div id="liked-grid" class="grid gap-4 md:grid-cols-3">
      <!-- Populated on the client from the main grid below -->
    </div>
  </section>

  <!-- Curated Pattern Families section -->
  <section class="space-y-4 mb-10">
    <header class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Pattern families</h2>
      <a href="/patterns/families" class="text-xs text-sparks-teal hover:underline">
        View all families →
      </a>
    </header>

    <div class="grid gap-3 md:grid-cols-3">
      {
        curatedFamilies.map((fam) => {
          const count = patterns.filter((p) => p.data.patternFamily === fam).length;

          return (
            <a
              href={`/patterns/families/${fam}`}
              class="p-4 rounded-2xl shadow-soft-card border border-sparks-amber/30 bg-white/80 hover:bg-sparks-sun/20 transition flex flex-col gap-2"
            >
              <h3 class="font-semibold text-sparks-ink">{fam}</h3>
              <p class="text-xs text-sparks-ink/70">
                {familyDescriptions[fam] ?? 'A neighborhood of related collaboration patterns.'}
              </p>
              <p class="text-[0.7rem] text-sparks-ink/60 mt-auto">
                {count} pattern{count === 1 ? '' : 's'}
              </p>
            </a>
          );
        })
      }
    </div>
  </section>

  <!-- Main Patterns section -->
  <section class="space-y-6">
    <header class="space-y-2">
      <h1 class="text-2xl font-semibold">Patterns</h1>
      <p class="text-sm text-sparks-ink/80 max-w-2xl">
        Each pattern captures a reusable solution to a recurring challenge in collaboration. Think
        of them as navigational aids in a complex terrain.
      </p>
    </header>

    <div class="grid gap-4 md:grid-cols-3">
      {
        patterns.map((p) => (
          <div data-pattern-slug={p.slug}>
            <PatternCard pattern={p} />
          </div>
        ))
      }
    </div>
  </section>

  <script>
    const likedGrid = document.getElementById('liked-grid');
    const likedEmpty = document.getElementById('liked-empty');

    function updateLikedShelf() {
      if (!likedGrid || !likedEmpty) return;

      // clear old shelf
      likedGrid.innerHTML = '';

      const cards = Array.from(document.querySelectorAll('[data-pattern-slug]'));

      let anyLiked = false;

      cards.forEach((card) => {
        const icon = card.querySelector('.cs-like-icon');
        if (!icon) return;

        const isLiked = icon.textContent === '★';

        // highlight liked in main grid
        card.classList.toggle('ring-2', isLiked);
        card.classList.toggle('ring-sparks-teal/60', isLiked);

        if (isLiked) {
          anyLiked = true;
          const clone = card.cloneNode(true);
          likedGrid.appendChild(clone);
        }
      });

      if (anyLiked) {
        likedEmpty.classList.add('hidden');
      } else {
        likedEmpty.classList.remove('hidden');
      }
    }

    // Run once after load (to pick up persisted likes)
    window.addEventListener('load', () => {
      updateLikedShelf();
    });

    // Re-run whenever likes change (event from LikeButton)
    window.addEventListener('csparks-likes-changed', () => {
      updateLikedShelf();
    });
  </script>
</BaseLayout>
